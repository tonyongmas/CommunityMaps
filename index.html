<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏® ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏°‡∏±‡∏™</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { 
      margin: 0; padding: 0; font-family: 'Prompt', sans-serif; 
      display: flex; flex-direction: column; height: 100vh; background-color: #f4f6f9; overflow: hidden;
    }

    /* Navbar */
    .navbar {
      background-color: #1A5276; color: white; padding: 10px 24px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1001;
    }

    .navbar-title { display: flex; align-items: center; gap: 15px; }
    .nav-logo { height: 60px; width: auto; filter: drop-shadow(0px 2px 4px rgba(0,0,0,0.3)); }
    .title-text { display: flex; flex-direction: column; justify-content: center; }
    .title-text h1 { margin: 0; font-size: 1.8rem; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    .title-text span { font-size: 1.1rem; color: #D6EAF8; margin-top: 2px; }

    .navbar-right { display: flex; align-items: center; gap: 15px; }

    .search-container { display: flex; gap: 8px; width: 350px; }
    .search-container input {
      flex-grow: 1; padding: 10px 15px; border-radius: 6px; border: none;
      font-family: 'Prompt', sans-serif; font-size: 0.95rem; outline: none; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    .search-container button {
      background-color: #3498DB; color: white; border: none; padding: 10px 20px;
      border-radius: 6px; cursor: pointer; font-family: 'Prompt', sans-serif; font-weight: 500; transition: 0.3s;
    }
    .search-container button:hover { background-color: #2980B9; }

    /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡πà‡∏≤‡∏á‡πÜ */
    .btn-measure {
      background-color: #9B59B6; color: white; border: none; padding: 10px 18px;
      font-family: 'Prompt', sans-serif; font-size: 1rem; border-radius: 6px;
      cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: 500; white-space: nowrap;
    }
    .btn-measure:hover { background-color: #8E44AD; transform: translateY(-2px); }
    .btn-measure.active { background-color: #E74C3C; }

    .btn-admin {
      background-color: #F39C12; color: white; border: none; padding: 10px 18px;
      font-family: 'Prompt', sans-serif; font-size: 1rem; border-radius: 6px;
      cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; font-weight: 500; white-space: nowrap;
    }
    .btn-admin:hover { background-color: #D68910; transform: translateY(-2px); }
    .btn-admin.active { background-color: #27AE60; }

    /* Sidebar */
    .content-area { display: flex; flex-grow: 1; position: relative; height: calc(100vh - 80px); }
    
    .sidebar {
      width: 340px; flex-shrink: 0; background-color: #ffffff; box-shadow: 3px 0 10px rgba(0,0,0,0.1);
      z-index: 1000; transition: margin-left 0.3s ease; display: flex; flex-direction: column;
    }
    .sidebar.collapsed { margin-left: -340px; }
    .sidebar-inner { display: flex; flex-direction: column; height: 100%; width: 340px; }
    
    .sidebar-header {
      background-color: #2C3E50; color: white; padding: 15px 20px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .sidebar-header h3 { margin: 0; font-size: 1.1rem; font-weight: 500; }
    .close-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
    
    .layer-list { padding: 10px; overflow-y: auto; flex-grow: 1; }
    .layer-group-container { margin-bottom: 8px; background: #fdfdfd; border: 1px solid #eee; border-radius: 6px; }
    .layer-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-radius: 6px; }
    .layer-item:hover { background-color: #f4f6f9; }
    .main-layer-item { border-bottom: 1px solid #f0f0f0; background-color: #f8f9fa; }
    .main-layer-item .layer-name { font-weight: 600; color: #2C3E50; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .main-layer-item .layer-name:hover { color: #3498DB; }
    
    .sub-layer-list { padding-left: 20px; padding-right: 10px; display: none; border-left: 2px solid #e0e0e0; margin-left: 15px; margin-bottom: 5px; }
    .sub-layer-list.open { display: block; }
    .sub-layer-item { padding: 8px 10px; border-bottom: 1px dashed #eee; }
    .sub-layer-item:last-child { border-bottom: none; }
    .sub-layer-item .layer-name { font-size: 0.9rem; color: #555; }
    
    .layer-actions { display: flex; gap: 15px; align-items: center; }
    .action-icon { cursor: pointer; font-size: 1.1rem; color: #2C3E50; transition: 0.2s; }
    .action-icon:hover { opacity: 0.7; }
    
    .open-sidebar-btn {
      position: absolute; top: 15px; left: 15px; z-index: 999;
      background: #2C3E50; color: white; border: none; padding: 10px 15px; font-family: 'Prompt', sans-serif;
      border-radius: 6px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      display: none; align-items: center; gap: 8px; font-size: 0.95rem;
    }

    #map { flex-grow: 1; width: 100%; z-index: 1; }

    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á SweetAlert2 ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏ß‡πá‡∏ö */
    div:where(.swal2-container) div:where(.swal2-popup) { font-family: 'Prompt', sans-serif !important; }

    @media (max-width: 950px) {
      .navbar { flex-direction: column; align-items: stretch; gap: 15px; }
      .navbar-title { justify-content: center; }
      .navbar-right { flex-direction: column; width: 100%; gap: 10px; }
      .search-container { width: 100%; }
      .btn-measure, .btn-admin { justify-content: center; width: 100%; }
      .sidebar { position: absolute; height: 100%; }
    }
  </style>
</head>
<body>

  <div class="navbar">
    <div class="navbar-title">
      <img src="https://img2.pic.in.th/pic/71f81565dc59a7f9545542493a5514ab.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏°‡∏±‡∏™" class="nav-logo">
      <div class="title-text">
        <h1>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h1>
        <span>‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ô‡∏´‡∏¢‡∏á‡∏°‡∏±‡∏™</span>
      </div>
    </div>
    
    <div class="navbar-right">
      <div class="search-container">
        <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...">
        <button id="searchBtn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
      <button id="measureBtn" class="btn-measure"><i class="fa-solid fa-ruler-combined"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î</button>
      <button id="adminBtn" class="btn-admin"><i class="fa-solid fa-user-shield"></i></button>
    </div>
  </div>

  <div class="content-area">
    <div id="sidebar" class="sidebar collapsed">
      <div class="sidebar-inner">
        <div class="sidebar-header">
          <h3><i class="fa-solid fa-layer-group"></i> ‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Layers)</h3>
          <button class="close-btn" id="closeSidebar" title="‡∏û‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö"><i class="fa-solid fa-chevron-left"></i></button>
        </div>
        <div id="layerList" class="layer-list"></div>
      </div>
    </div>

    <button class="open-sidebar-btn" id="openSidebar" style="display: flex;">
      <i class="fa-solid fa-chevron-right"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    </button>

    <div id="map"></div>
  </div>

  <script>
    const MAP_CENTER = [6.29445, 101.72362];
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzN3IxvSwJEd2Zz3zhf53R0130SCEMPm4IEmhJPRy0rmgX-QsagZMhHTP7VTUyHi0u_/exec'; // ‚ö†Ô∏è ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    const ADMIN_PASSWORD = "1234";

    const streetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '¬© OpenStreetMap' });
    const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
      maxZoom: 18, attribution: '¬© Esri' 
    });

    const map = L.map('map', { center: MAP_CENTER, zoom: 15, layers: [streetMap], zoomControl: false });
    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    L.control.layers({ "üó∫Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏ô‡∏ô": streetMap, "üõ∞Ô∏è ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°": satelliteMap }, null, { position: 'bottomright' }).addTo(map);

    const layerGroups = {}; 
    const lockedLayers = {}; 
    let highlightHalo = null; 
    let selectedLayer = null; 
    let allSearchableLayers = []; 

    document.getElementById('closeSidebar').onclick = () => {
      document.getElementById('sidebar').classList.add('collapsed');
      document.getElementById('openSidebar').style.display = 'flex'; 
      setTimeout(() => map.invalidateSize(), 300);
    };
    document.getElementById('openSidebar').onclick = () => {
      document.getElementById('sidebar').classList.remove('collapsed');
      document.getElementById('openSidebar').style.display = 'none'; 
      setTimeout(() => map.invalidateSize(), 300);
    };

    function renderSidebar() {
      const layerList = document.getElementById('layerList');
      layerList.innerHTML = '';

      Object.keys(layerGroups).forEach(sheetName => {
        
        // üåü ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ "‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•"
        let hasBoundary = layerGroups[sheetName]['üî≤ ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•'] !== undefined;
        lockedLayers[sheetName] = hasBoundary; 

        const groupContainer = document.createElement('div');
        groupContainer.className = 'layer-group-container';

        const mainDiv = document.createElement('div');
        mainDiv.className = 'layer-item main-layer-item';

        const mainName = document.createElement('span');
        mainName.className = 'layer-name';
        mainName.innerHTML = `<i class="fa-solid fa-chevron-right toggle-arrow" style="width:15px"></i> ${sheetName}`;

        const mainActions = document.createElement('div');
        mainActions.className = 'layer-actions';

        const mainEyeIcon = document.createElement('span');
        mainEyeIcon.className = 'action-icon';
        mainEyeIcon.innerHTML = '<i class="fa-solid fa-eye"></i>'; 
        mainEyeIcon.title = "‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏ô‡∏µ‡πâ";

        const lockIcon = document.createElement('span');
        lockIcon.className = 'action-icon';
        
        // ‡∏´‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÅ‡∏î‡∏á
        if (lockedLayers[sheetName]) {
          lockIcon.innerHTML = '<i class="fa-solid fa-lock"></i>'; 
          lockIcon.style.color = '#E74C3C';
        } else {
          lockIcon.innerHTML = '<i class="fa-solid fa-lock-open"></i>'; 
          lockIcon.title = "‡∏•‡πá‡∏≠‡∏Ñ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
        }

        mainActions.appendChild(mainEyeIcon);
        mainActions.appendChild(lockIcon);
        mainDiv.appendChild(mainName);
        mainDiv.appendChild(mainActions);

        const subListContainer = document.createElement('div');
        subListContainer.className = 'sub-layer-list'; 

        mainName.onclick = () => {
          subListContainer.classList.toggle('open');
          const arrow = mainName.querySelector('.toggle-arrow');
          if(subListContainer.classList.contains('open')) arrow.classList.replace('fa-chevron-right', 'fa-chevron-down');
          else arrow.classList.replace('fa-chevron-down', 'fa-chevron-right');
        };

        let isMainEyeOpen = true;
        const subCats = Object.keys(layerGroups[sheetName]);

        subCats.forEach(catName => {
          const subDiv = document.createElement('div');
          subDiv.className = 'layer-item sub-layer-item';

          const subName = document.createElement('span');
          subName.className = 'layer-name';
          subName.innerText = catName;

          const subActions = document.createElement('div');
          subActions.className = 'layer-actions';

          const subEyeIcon = document.createElement('span');
          subEyeIcon.className = 'action-icon';
          subEyeIcon.innerHTML = '<i class="fa-solid fa-eye"></i>';
          const safeId = `${sheetName}-${catName}`.replace(/\s+/g, '-');
          subEyeIcon.id = `eye-${safeId}`;

          subEyeIcon.onclick = () => {
            const group = layerGroups[sheetName][catName];
            if (map.hasLayer(group)) {
              map.removeLayer(group);
              subEyeIcon.innerHTML = '<i class="fa-solid fa-eye-slash"></i>'; subEyeIcon.style.color = '#95A5A6';
            } else {
              map.addLayer(group);
              subEyeIcon.innerHTML = '<i class="fa-solid fa-eye"></i>'; subEyeIcon.style.color = '#2C3E50';
              if (lockedLayers[sheetName]) {
                group.eachLayer(layer => {
                  if (layer.getElement) layer.getElement().style.pointerEvents = 'none';
                  if (layer._icon) layer._icon.style.pointerEvents = 'none';
                });
              }
            }
          };

          subActions.appendChild(subEyeIcon);
          subDiv.appendChild(subName);
          subDiv.appendChild(subActions);
          subListContainer.appendChild(subDiv);
        });

        mainEyeIcon.onclick = () => {
          isMainEyeOpen = !isMainEyeOpen;
          if (isMainEyeOpen) {
            mainEyeIcon.innerHTML = '<i class="fa-solid fa-eye"></i>'; mainEyeIcon.style.color = '#2C3E50';
            subCats.forEach(catName => {
              const group = layerGroups[sheetName][catName];
              if (!map.hasLayer(group)) map.addLayer(group);
              const subEye = document.getElementById(`eye-${sheetName}-${catName}`.replace(/\s+/g, '-'));
              if(subEye) { subEye.innerHTML = '<i class="fa-solid fa-eye"></i>'; subEye.style.color = '#2C3E50'; }
            });
          } else {
            mainEyeIcon.innerHTML = '<i class="fa-solid fa-eye-slash"></i>'; mainEyeIcon.style.color = '#95A5A6';
            subCats.forEach(catName => {
              const group = layerGroups[sheetName][catName];
              if (map.hasLayer(group)) map.removeLayer(group);
              const subEye = document.getElementById(`eye-${sheetName}-${catName}`.replace(/\s+/g, '-'));
              if(subEye) { subEye.innerHTML = '<i class="fa-solid fa-eye-slash"></i>'; subEye.style.color = '#95A5A6'; }
            });
          }
        };

        lockIcon.onclick = () => {
          lockedLayers[sheetName] = !lockedLayers[sheetName];
          const isLocked = lockedLayers[sheetName];

          if (isLocked) { lockIcon.innerHTML = '<i class="fa-solid fa-lock"></i>'; lockIcon.style.color = '#E74C3C'; } 
          else { lockIcon.innerHTML = '<i class="fa-solid fa-lock-open"></i>'; lockIcon.style.color = '#2C3E50'; }

          subCats.forEach(catName => {
            layerGroups[sheetName][catName].eachLayer(layer => {
              if (layer.getElement && layer.getElement()) layer.getElement().style.pointerEvents = isLocked ? 'none' : 'auto';
              if (layer._icon) layer._icon.style.pointerEvents = isLocked ? 'none' : 'auto';
            });
          });

          if (isLocked && selectedLayer && selectedLayer.sheetName === sheetName) {
            resetHighlight(); map.closePopup();
          }
        };

        groupContainer.appendChild(mainDiv);
        groupContainer.appendChild(subListContainer);
        layerList.appendChild(groupContainer);

        // üåü ‡∏´‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Ñ‡πÅ‡∏ï‡πà‡πÅ‡∏£‡∏Å ‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡∏£‡∏±‡∏ô‡∏ä‡πâ‡∏≤‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à)
        if (lockedLayers[sheetName]) {
          setTimeout(() => {
            subCats.forEach(catName => {
              layerGroups[sheetName][catName].eachLayer(layer => {
                if (layer.getElement && layer.getElement()) layer.getElement().style.pointerEvents = 'none';
                if (layer._icon) layer._icon.style.pointerEvents = 'none';
              });
            });
          }, 500);
        }

      });
    }

    function resetHighlight() {
      if (highlightHalo) { map.removeLayer(highlightHalo); highlightHalo = null; }
      if (selectedLayer && selectedLayer.defaultStyle) { 
        selectedLayer.setStyle(selectedLayer.defaultStyle); selectedLayer = null; 
      }
    }

    map.on('click', resetHighlight);

    function triggerHighlight(layer) {
      if (lockedLayers[layer.sheetName]) return;
      resetHighlight();
      
      if (layer instanceof L.Marker) { map.flyTo(layer.getLatLng(), 17, { duration: 1.5 }); layer.openPopup(); return; }

      selectedLayer = layer;
      const isPolygon = selectedLayer instanceof L.Polygon;
      const currentWeight = selectedLayer.defaultStyle.weight || 2;
      const haloStyle = { color: '#FFFFFF', weight: currentWeight + 6, opacity: 1, fill: false, dashArray: '' };

      if (isPolygon) highlightHalo = L.polygon(selectedLayer.getLatLngs(), haloStyle).addTo(map);
      else highlightHalo = L.polyline(selectedLayer.getLatLngs(), haloStyle).addTo(map);

      if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { highlightHalo.bringToFront(); selectedLayer.bringToFront(); }
      if (selectedLayer.defaultStyle.fillOpacity > 0) selectedLayer.setStyle({ fillOpacity: 0.6 });

      map.flyToBounds(selectedLayer.getBounds(), { padding: [50, 50], maxZoom: 16, duration: 1.5 });
      selectedLayer.openPopup();
    }

    // --- ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ---
    // (‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î)
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

    fetch(SCRIPT_URL)
      .then(response => response.json())
      .then(data => {
        data.forEach(item => {
          try {
            const latlngs = JSON.parse(item.coords);
            let mapLayer; let defaultStyle = {}; 
            
            let categoryName = 'üü© ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡∏∏‡∏°‡∏ä‡∏ô';
            if (item.type === 'marker') categoryName = 'üìç ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç';
            else if (item.type === 'polyline') categoryName = 'üõ£Ô∏è ‡∏ñ‡∏ô‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô';
            else if (item.type === 'boundary') categoryName = 'üî≤ ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•';

            if (item.type === 'marker') {
              let markerOptions = {};
              if (item.icon && item.icon.trim() !== "") {
                markerOptions.icon = L.icon({ iconUrl: item.icon, iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
              }
              mapLayer = L.marker(latlngs, markerOptions);
            } else {
              if (item.type === 'boundary') defaultStyle = { color: item.color || '#FF0000', weight: 4, dashArray: '10, 10', fillOpacity: 0 };
              else if (item.type === 'polyline') defaultStyle = { color: item.color, weight: 5, opacity: 0.9 };
              else defaultStyle = { color: item.color, fillColor: item.color, fillOpacity: 0.4, weight: 2 };
              
              mapLayer = item.type === 'polyline' ? L.polyline(latlngs, defaultStyle) : L.polygon(latlngs, defaultStyle);
              mapLayer.defaultStyle = defaultStyle;
            }
            
            mapLayer.sheetName = item.sheetName; 
            mapLayer.categoryName = categoryName; 
            mapLayer.bindPopup(`<div style="font-family:'Prompt'; font-size:14px; text-align:center;"><b>${item.name}</b><br><small>(${item.sheetName} - ${categoryName.substring(2)})</small></div>`);

            mapLayer.on('click', function(e) { L.DomEvent.stopPropagation(e); triggerHighlight(e.target); });

            if (!layerGroups[item.sheetName]) layerGroups[item.sheetName] = {};
            if (!layerGroups[item.sheetName][categoryName]) layerGroups[item.sheetName][categoryName] = L.layerGroup().addTo(map);
            
            layerGroups[item.sheetName][categoryName].addLayer(mapLayer);
            allSearchableLayers.push({ name: item.name, layer: mapLayer, sheetName: item.sheetName, catName: categoryName });

          } catch(e) { console.error("‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: " + item.name); }
        });
        renderSidebar(); 
        Swal.close(); // ‡∏õ‡∏¥‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
      })
      .catch(err => {
        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        console.error(err);
      });

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÉ‡∏ä‡πâ SweetAlert2 ‡πÅ‡∏ó‡∏ô Alert) ---
    function executeSearch() {
      const searchValue = document.getElementById('searchInput').value.trim().toLowerCase();
      if(!searchValue) return;

      const result = allSearchableLayers.find(item => item.name.toLowerCase().includes(searchValue));
      
      if (result) {
        const targetGroup = layerGroups[result.sheetName][result.catName];
        if (!map.hasLayer(targetGroup)) {
          map.addLayer(targetGroup);
          const safeId = `${result.sheetName}-${result.catName}`.replace(/\s+/g, '-');
          const eyeIcon = document.getElementById(`eye-${safeId}`);
          if(eyeIcon) { eyeIcon.innerHTML = '<i class="fa-solid fa-eye"></i>'; eyeIcon.style.color = '#2C3E50'; }
        }

        if (lockedLayers[result.sheetName]) {
           // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ SweetAlert2 ‡πÅ‡∏ö‡∏ö‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•
           Swal.fire({
             title: '‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ!',
             html: `‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö <b>${result.name}</b><br>‡πÅ‡∏ï‡πà‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Ñ‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏õ‡∏´‡∏≤‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö`,
             icon: 'info', timer: 4000, showConfirmButton: false, position: 'top-end', toast: true
           });
           if (result.layer instanceof L.Marker) map.flyTo(result.layer.getLatLng(), 17);
           else map.flyToBounds(result.layer.getBounds(), { padding: [50, 50], maxZoom: 16 });
        } else {
           triggerHighlight(result.layer);
        }
      } else { 
        Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•!', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); 
      }
    }

    document.getElementById('searchBtn').addEventListener('click', executeSearch);
    document.getElementById('searchInput').addEventListener('keypress', function (e) { if (e.key === 'Enter') executeSearch(); });

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ SweetAlert2) ---
    let isMeasureMode = false;
    let currentMeasureDrawer = null;
    const measureLayerGroup = new L.FeatureGroup().addTo(map);

    function startMeasureMode() {
      measureLayerGroup.clearLayers(); 
      isMeasureMode = true;
      currentMeasureDrawer.enable(); 
      document.getElementById('measureBtn').innerHTML = '<i class="fa-solid fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î';
      document.getElementById('measureBtn').classList.add('active');
    }

    document.getElementById('measureBtn').addEventListener('click', () => {
      if (isMeasureMode) {
        if(currentMeasureDrawer) currentMeasureDrawer.disable();
        isMeasureMode = false;
        document.getElementById('measureBtn').innerHTML = '<i class="fa-solid fa-ruler-combined"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î';
        document.getElementById('measureBtn').classList.remove('active');
        measureLayerGroup.clearLayers(); 
      } else {
        // ‡πÉ‡∏ä‡πâ SweetAlert2 ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 2 ‡∏õ‡∏∏‡πà‡∏°
        Swal.fire({
          title: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î',
          icon: 'question',
          showDenyButton: true,
          showCancelButton: true,
          confirmButtonText: '<i class="fa-solid fa-route"></i> ‡∏ß‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á',
          denyButtonText: '<i class="fa-solid fa-draw-polygon"></i> ‡∏ß‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà',
          cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
          confirmButtonColor: '#9B59B6',
          denyButtonColor: '#3498DB'
        }).then((result) => {
          if (result.isConfirmed) {
            currentMeasureDrawer = new L.Draw.Polyline(map, { shapeOptions: { color: '#9B59B6', weight: 5, dashArray: '5, 5' } });
            startMeasureMode();
          } else if (result.isDenied) {
            currentMeasureDrawer = new L.Draw.Polygon(map, { shapeOptions: { color: '#9B59B6', weight: 3, fillOpacity: 0.3 } });
            startMeasureMode();
          }
        });
      }
    });

    const drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
    const drawControl = new L.Control.Draw({ edit: { featureGroup: drawnItems }, draw: { polygon: true, polyline: true, marker: true, rectangle: false, circle: false, circlemarker: false } });

    map.on(L.Draw.Event.CREATED, function (event) {
      const layer = event.layer; 
      const type = event.layerType; 
      
      if (isMeasureMode) {
        measureLayerGroup.addLayer(layer);
        
        if (type === 'polyline') {
          let latlngs = layer.getLatLngs();
          let distance = 0;
          for (let i = 0; i < latlngs.length - 1; i++) distance += latlngs[i].distanceTo(latlngs[i + 1]);
          let txt = distance > 1000 ? (distance/1000).toFixed(2) + ' ‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£' : distance.toFixed(0) + ' ‡πÄ‡∏°‡∏ï‡∏£';
          layer.bindPopup(`<div style="font-family:'Prompt'; text-align:center;"><b>üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°:</b><br>${txt}</div>`).openPopup();
        } 
        else if (type === 'polygon') {
          let latlngs = layer.getLatLngs()[0];
          let area = L.GeometryUtil.geodesicArea(latlngs);
          let rai = Math.floor(area / 1600);
          let remainderArea = area % 1600;
          let ngan = Math.floor(remainderArea / 400);
          let sqwa = (remainderArea % 400) / 4;
          layer.bindPopup(`<div style="font-family:'Prompt'; text-align:center;"><b>üìê ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°:</b><br>${area.toFixed(0)} ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£<br><hr style="margin:5px 0"><small style="color:#E74C3C"><b>‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${rai} ‡πÑ‡∏£‡πà ${ngan} ‡∏á‡∏≤‡∏ô ${sqwa.toFixed(1)} ‡∏ï‡∏£.‡∏ß.</b></small></div>`).openPopup();
        }

        isMeasureMode = false;
        document.getElementById('measureBtn').innerHTML = '<i class="fa-solid fa-ruler-combined"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î';
        document.getElementById('measureBtn').classList.remove('active');

      } else {
        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏¢ SweetAlert2 ---
        let coordsArray;
        if (type === 'polygon') coordsArray = layer.getLatLngs()[0].map(point => [point.lat, point.lng]);
        else if (type === 'polyline') coordsArray = layer.getLatLngs().map(point => [point.lat, point.lng]);
        else if (type === 'marker') coordsArray = [layer.getLatLng().lat, layer.getLatLng().lng];
        
        const coordsString = JSON.stringify(coordsArray);
        let typeTH = type === 'polygon' ? '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà' : (type === 'polyline' ? '‡πÄ‡∏™‡πâ‡∏ô‡∏ñ‡∏ô‡∏ô' : '‡∏à‡∏∏‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà');
        
        Swal.fire({
          title: `‡πÄ‡∏û‡∏¥‡πà‡∏°${typeTH}‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!`,
          html: `<p style="font-size:0.95rem">‡∏Å‡πä‡∏≠‡∏õ‡∏õ‡∏µ‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô <b>‡∏ä‡πà‡∏≠‡∏á C</b> ‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£<br><small style="color:gray;">(‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ <b>${type}</b> ‡∏•‡∏á‡πÉ‡∏ô <b>‡∏ä‡πà‡∏≠‡∏á D</b> ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö)</small></p>`,
          input: 'textarea',
          inputValue: coordsString,
          showCancelButton: true,
          confirmButtonText: '<i class="fa-solid fa-copy"></i> ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î',
          cancelButtonText: '‡∏õ‡∏¥‡∏î',
          confirmButtonColor: '#27AE60',
          didOpen: () => {
            const input = Swal.getInput();
            input.style.height = '120px';
            input.setAttribute('readonly', true);
          }
        }).then((result) => {
          if (result.isConfirmed) {
            navigator.clipboard.writeText(coordsString).then(() => {
              Swal.fire({ icon: 'success', title: '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', text: '‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô Google Sheet ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö', timer: 2000, showConfirmButton: false });
            });
          }
        });
        drawnItems.addLayer(layer);
      }
    });

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Admin (‡πÉ‡∏ä‡πâ SweetAlert2 ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö) ---
    let isAdmin = false;
    document.getElementById('adminBtn').addEventListener('click', () => {
      if (isAdmin) { 
        Swal.fire('‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô', '‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö', 'info'); 
        return; 
      }
      
      Swal.fire({
        title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
        input: 'password',
        inputPlaceholder: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô...',
        showCancelButton: true,
        confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#F39C12'
      }).then((result) => {
        if (result.isConfirmed) {
          if (result.value === ADMIN_PASSWORD) {
            isAdmin = true; map.addControl(drawControl); 
            const btn = document.getElementById('adminBtn');
            btn.innerHTML = '<i class="fa-solid fa-user-shield"></i> ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)'; 
            btn.classList.add('active');
            Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏≤‡∏î‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠', timer: 2500, showConfirmButton: false });
          } else { 
            Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error'); 
          }
        }
      });
    });
  </script>
</body>
</html>
